<div class="checkout-container">
  <h1 class="checkout-title">Checkout</h1>

  <div class="checkout-layout">
    <div class="checkout-main">
      <div class="checkout-section">
        <h2>Shipping Address</h2>

        @if (addresses.length === 0) {
        <p class="no-addresses">You don't have any saved addresses</p>
        <button class="btn-add-address" (click)="isAddingAddress = true">Add Address</button>
        } @else {
        <div class="address-list">
          @for (address of addresses; track address) {
          <app-user-address-card [address]="address" [selectedAddress]="selectedAddress!"
            (addressSelect)="onAddressSelect(address)"></app-user-address-card>
          }
        </div>
        <button class="btn-add-address" [disabled]="isAddingAddress" (click)="isAddingAddress = true">Add New
          Address</button>
        }

        @if (isAddingAddress) {
        <app-user-add-address [newAddress]="newAddress" [addressFormError]="addressFormError"
          [addressSaveError]="addressSaveError" [isAddingAddress]="isAddingAddress" (addressSave)="saveNewAddress()"
          (onClose)="closeForm()" />
        }
      </div>

      <div class="checkout-section">
        <h2>Payment Method</h2>
        <div class="payment-methods">
          @for (method of paymentMethods; track method.id) {
          <app-payment-methods [method]="method" [selectedPayment]="selectedPayment"
            (onPaymentMethodSelect)="selectPaymentMethod(method.id)" />
          }
        </div>
      </div>
    </div>

    <div class="checkout-sidebar">
      <div class="checkout-section summary-section">
        <h2>Order Summary</h2>
        <div class="summary-items">
          <div class="summary-row">
            <span>Items ({{ cart.length }}):</span>
            <span>${{ subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row">
            <span>Shipping:</span>
            <span>
              @if (shipping > 0) {
              ${{ shipping | number:'1.2-2' }}
              } @else {
              Free
              }
            </span>
          </div>
          <div class="summary-row">
            <span>Tax:</span>
            <span>${{ tax | number:'1.2-2' }}</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span>${{ total | number:'1.2-2' }}</span>
          </div>
        </div>

        <div class="delivery-info">
          <p>Estimated delivery: <strong>{{ estimatedDeliveryDate }}</strong></p>
        </div>

        @if (orderError) {
        <div class="error-message">{{ orderError }}</div>
        }

        <button class="place-order-btn" [disabled]="!selectedAddress || !selectedPayment || isProcessingOrder"
          (click)="placeOrder()">

          @if (isProcessingOrder) {
          <div class="order-processing">
            <div class="spinner"></div>
            <span>{{ orderProcessingStage }}</span>
          </div>
          } @else {
          Place Order
          }
        </button>
      </div>
    </div>
  </div>
</div>